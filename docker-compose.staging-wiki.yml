# Docker Compose for Staging Wiki Instance
#
# Fresh MediaWiki for testing the migration pipeline.
# This is the TARGET wiki â€” content gets uploaded here.
#
# Usage:
#   cp .env.staging.example .env.staging  # fill in credentials
#   docker compose -f docker-compose.staging-wiki.yml --env-file .env.staging up -d
#   docker compose -f docker-compose.staging-wiki.yml down -v

services:
  staging-wiki-db:
    image: mysql:8.0
    container_name: staging-wiki-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MW_DB_NAME}
      MYSQL_USER: ${MW_DB_USER}
      MYSQL_PASSWORD: ${MW_DB_PASSWORD}
    volumes:
      - staging_wiki_db_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - staging-wiki-net

  staging-wiki:
    image: mediawiki:1.39-fpm
    container_name: staging-wiki-app
    depends_on:
      staging-wiki-db:
        condition: service_healthy
    volumes:
      - staging_wiki_html:/var/www/html
      - ./staging-wiki-config/LocalSettings.php:/var/www/html/LocalSettings.php:ro
      - ./staging-wiki-extensions/WikiSEO:/var/www/html/extensions/WikiSEO:ro
    environment:
      MW_DB_NAME: ${MW_DB_NAME}
      MW_DB_USER: ${MW_DB_USER}
      MW_DB_PASSWORD: ${MW_DB_PASSWORD}
      MW_SECRET_KEY: ${MW_SECRET_KEY}
      MW_UPGRADE_KEY: ${MW_UPGRADE_KEY}
    networks:
      - staging-wiki-net

  staging-wiki-web:
    image: nginx:alpine
    container_name: staging-wiki-web
    depends_on:
      - staging-wiki
    ports:
      - "8082:80"
    volumes:
      - staging_wiki_html:/var/www/html:ro
      - ./staging-wiki-config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./static:/var/www/static:ro
    networks:
      - staging-wiki-net

volumes:
  staging_wiki_db_data:
  staging_wiki_html:

networks:
  staging-wiki-net:
    driver: bridge

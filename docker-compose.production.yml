# Docker Compose for Production Wiki Instance
#
# Hardened MediaWiki for wiki.dreamfactory.com
# All credentials supplied via environment variables (.env file).
#
# Usage:
#   cp .env.example .env   # then fill in real values
#   docker compose -f docker-compose.production.yml up -d

services:
  wiki-db:
    image: mysql:8.0
    container_name: wiki-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MW_DB_NAME:-wiki_production}
      MYSQL_USER: ${MW_DB_USER:-wiki_user}
      MYSQL_PASSWORD: ${MW_DB_PASSWORD}
    volumes:
      - wiki_db_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - wiki-net

  wiki-app:
    image: mediawiki:1.39-fpm
    container_name: wiki-app
    restart: unless-stopped
    depends_on:
      wiki-db:
        condition: service_healthy
    volumes:
      - wiki_html:/var/www/html
      - ./production-wiki-config/LocalSettings.php:/var/www/html/LocalSettings.php:ro
      - ./staging-wiki-extensions/WikiSEO:/var/www/html/extensions/WikiSEO:ro
    environment:
      MW_DB_NAME: ${MW_DB_NAME:-wiki_production}
      MW_DB_USER: ${MW_DB_USER:-wiki_user}
      MW_DB_PASSWORD: ${MW_DB_PASSWORD}
      MW_SECRET_KEY: ${MW_SECRET_KEY}
      MW_UPGRADE_KEY: ${MW_UPGRADE_KEY}
    networks:
      - wiki-net

  wiki-web:
    image: nginx:alpine
    container_name: wiki-web
    restart: unless-stopped
    depends_on:
      - wiki-app
    ports:
      - "${WIKI_PORT:-8080}:80"
    volumes:
      - wiki_html:/var/www/html:ro
      - ./production-wiki-config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./static:/var/www/static:ro
    networks:
      - wiki-net

volumes:
  wiki_db_data:
  wiki_html:

networks:
  wiki-net:
    driver: bridge
